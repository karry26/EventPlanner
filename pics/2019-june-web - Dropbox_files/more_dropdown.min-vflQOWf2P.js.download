define(["require","exports","tslib","react","external/lodash","external/react-redux","spectrum/popover","modules/clean/previews/data/selectors","modules/clean/previews/util","modules/clean/react/file_action_button_type","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/data/selectors","file-viewer/core","modules/clean/react/file_viewer/utils","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_viewer/more_dropdown/views","modules/clean/react/size_class/constants","modules/clean/file_store/utils","modules/clean/react/title_bar/overflow_menu","modules/core/browser","modules/core/i18n","modules/clean/react/paper/utils","react-dom","modules/clean/react/paper/open_in_paper_callout_loader","modules/clean/react/paper/open_in_paper_button","modules/clean/react/file_viewer/data/actions","modules/clean/previews/util","modules/clean/react/extensions/download_intercept","modules/clean/react/extensions/data/action_creators","modules/clean/react/watermarking/callout","modules/clean/react/watermarking/utils"],function(e,t,o,n,r,i,a,l,s,c,p,u,d,m,f,h,_,g,v,w,C,k,A,I,M,y,O,S,b,F,E,P,B){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=o.__importDefault(n),r=o.__importStar(r),s=o.__importStar(s),M=o.__importStar(M);var D=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.state=t.getStateFromRegistry(),t.onRegistryUpdate=function(){t.setState(t.getStateFromRegistry())},t.handleDownloadClick=function(e){e.preventDefault(),S.download(t.props.file);var o=t.props.setInDownloadInterceptFlow;if(t.props.extensionsConfig&&w.isBrowseFile(t.props.file)&&t.props.user&&o&&t.props.sizeClass===v.SizeClass.Large){var n=function(){o({inDownloadInterceptFlow:!0})};F.onDownloadFile(t.props.extensionsConfig,t.props.user,t.props.file.ext,n)}return p.logUserAction(u.UserAction.Download,u.UserActionContext.TitleBarMore)},t.handleRemoveLinkClick=function(e){e.preventDefault(),t.props.onRemoveShareLink&&(t.props.onRemoveShareLink(),p.logUserAction(u.UserAction.RemoveLink,u.UserActionContext.TitleBarMore))},t.handlePreviousVersionClick=function(e){if(e.preventDefault(),!t.props.user)throw new Error("User not specified");return s.redirectToVersionHistory(t.props.file,t.props.user),p.logUserAction(u.UserAction.ViewRevisions,u.UserActionContext.TitleBarMore)},t.handleSignInClick=function(e){e.preventDefault(),p.logUserAction(u.UserAction.SignIn,u.UserActionContext.TitleBarMore),k.redirect(f.getSharedLinkLoginUrl())},t.handleWatermarkingModeToggle=function(e){return o.__awaiter(t,void 0,void 0,function(){var t,n,r;return o.__generator(this,function(o){return e.preventDefault(),t=this.props,n=t.mode,(r=t.changeMode)?(n===m.FileViewerMode.Watermarking?(p.logUserAction(u.UserAction.WatermarkCancel,u.UserActionContext.TitleBarMore),r(m.FileViewerMode.Default)):(p.logUserAction(u.UserAction.WatermarkEnable,u.UserActionContext.TitleBarMore),r(m.FileViewerMode.Watermarking)),[2]):[2]})})},t.handleOpenInPaperClick=function(e){e.preventDefault();var o={file:t.props.file,user:t.props.user,sharedLink:t.props.sharedLink,fromModal:!1};I.openFileInPaper(o)},t.handleClick=function(){t.setState({hasBeenClicked:!0})},t}return o.__extends(t,e),t.prototype.componentDidMount=function(){this.removeRegistryListener=_.moreOptionRegistry.addListener(this.onRegistryUpdate)},t.prototype.componentWillUnmount=function(){this.removeRegistryListener()},t.prototype.getStateFromRegistry=function(){var e=this.state||{hasBeenClicked:!1,registeredItems:[]},t=o.__assign({},e,{registeredItems:_.moreOptionRegistry.getOptionItems()}),n=this.getOptionItemsContent(t.registeredItems),i=this.getOptionItemsContent(e.registeredItems);return r.isEqual(n,i)||(t.hasBeenClicked=!1),t},t.prototype.getOptionItemsContent=function(e){var t=this;return e.reduce(function(e,o){return o instanceof h.MoreOption?e.push(t.getMoreOptionContent(o)):e=e.concat(o.options.map(t.getMoreOptionContent)),e},[])},t.prototype.getMoreOptionContent=function(e){return c.getFileActionButtonText(e.fileActionButtonType)},t.prototype.getPopoverContent=function(){var e=this.props,t=e.allowRemoveLink,o=e.isPrivate,r=e.mode,i=e.onRemoveShareLink,l=e.renderSignIn,s=e.shareDownloadOptions,p=e.sizeClass,u=e.showOpenInPaper,d=e.file,f=e.user,h=[],_=p===v.SizeClass.Small,w=p===v.SizeClass.Medium,k=p===v.SizeClass.Large;if(o&&w&&h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__share",key:"more-button__share",onSelect:this.props.onClickShareLink},c.getFileActionButtonText(c.FileActionButtonType.SHARE))),null!=i&&t&&!_&&h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__remove",key:"more-button__remove",onSelect:this.handleRemoveLinkClick},c.getFileActionButtonText(c.FileActionButtonType.REMOVE_LINK))),o&&h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__download",key:"more-button__download",onSelect:this.handleDownloadClick},c.getFileActionButtonText(c.FileActionButtonType.DOWNLOAD))),s)for(var I=0,M=s;I<M.length;I++){var y=M[I];if(!y.isDisabled){var S="more-button-sl__"+y.userAction;h.push(n.default.createElement(U,{handler:y.handler,key:S,text:y.text,userAction:y.userAction}))}}if(o&&!_&&h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__version-history",key:"more-button__version-history",onSelect:this.handlePreviousVersionClick},c.getFileActionButtonText(c.FileActionButtonType.PREVIOUS_VERSIONS))),k){var F=g.getPopoverOrMobileItemsForMoreOptions(this.state.registeredItems);h=h.concat(F)}if(B.allowWatermark(d,f)){h.push(n.default.createElement(a.PopoverContentSeparator,{key:"more_button__separator2"}));var E=r===m.FileViewerMode.Watermarking?c.FileActionButtonType.REMOVE_WATERMARKING:c.FileActionButtonType.ENABLE_WATERMARKING;h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__watermarking-toggle",key:"more-button__watermarking-toggle",onSelect:this.handleWatermarkingModeToggle},c.getFileActionButtonText(E)))}return l&&h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__sign-in",key:"more-button__sign-in",onSelect:this.handleSignInClick},b.isCloudDocPreview(d)?A._("Edit now"):A._("Sign in"))),u&&(k&&h.length&&this.state.registeredItems.length&&h.push(n.default.createElement(a.PopoverContentSeparator,{key:"more_button__separator2"})),h.push(n.default.createElement(C.PopoverOrMobileItem,{className:"more-button__open-in-paper",key:"more-button__open-in-paper",onSelect:this.handleOpenInPaperClick},n.default.createElement(O.OpenInPaperButtonInMoreDropdown,{file:d,handleOpenInPaperClick:this.handleOpenInPaperClick,sizeClass:p})))),h},t.prototype.render=function(){var e=this,t=this.props,o=t.file,r=t.sizeClass,i=t.showOpenInPaper,a=t.user,l=this.state.hasBeenClicked,s=b.isCloudDocPreview(o);return n.default.createElement("div",{ref:function(t){e.ref=M.findDOMNode(t)},onClick:this.handleClick},n.default.createElement(C.OverflowMenu,{contentWrapperClassName:"react-file-viewer-dropdown",hideOnDisabled:s},this.getPopoverContent()),i?n.default.createElement(y.OpenInPaperCalloutLoader,{file:o,parentHasBeenClicked:l,sizeClass:r,targetNode:this.ref,user:a,variant:I.OpenInPaperButtonVariant.Ellipsis}):null,B.allowWatermark(o,a)?n.default.createElement(P.WatermarkingCallout,{targetNode:this.ref,parentHasBeenClicked:l}):null)},t})(n.default.Component);t._MoreDropdown=D;var R=function(e){var t=d.getActiveFile(e);return{isFileRendered:d.getRenderStatusForCurrentFile(e)===u.PreviewRenderStatus.Succeeded,mode:d.getMode(e),previewApiData:l.getApiDataForFile(e,t)}},x=i.connect(R,{changeMode:S.changeMode,setInDownloadInterceptFlow:E.setInDownloadInterceptFlow})(D);t.MoreDropdown=x;var U=(function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handleClick=function(){var e=t.props,o=e.handler,n=e.userAction;p.logUserAction(n,u.UserActionContext.TitleBarMore),o()},t}return o.__extends(t,e),t.prototype.render=function(){var e=this.props.text;return n.default.createElement(C.PopoverOrMobileItem,{onSelect:this.handleClick},e)},t})(n.default.PureComponent)});
//# sourceMappingURL=more_dropdown.min.js-vflXdoTLQ.map