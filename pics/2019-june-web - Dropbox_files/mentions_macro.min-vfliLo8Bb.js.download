define(["require","exports","tslib","spectrum_comments/comment_editor/core/class_decorators","spectrum_comments/comment_editor/layers/scaffold","draft-js","spectrum_comments/comment_editor/layers/macro","spectrum_comments/comment_editor/components/mention_suggestions_list_component","spectrum_comments/comment_editor/draft_utils"],function(e,t,n,o,i,r,s,a,u){"use strict";function c(e){var t=e.editorState,n=e.identifier,o=e.blockKey,i=e.start,s=e.end,a=e.text,c={identifier:n,type:"email"},g=t.getCurrentContent(),p=g.createEntity("mention","IMMUTABLE",c),m=p.getLastCreatedEntityKey(),l=u.replaceText(p,o,i,s,"@"+a,m);return{editorState:u.replaceContent(t,r.Modifier.insertText(l,l.getSelectionAfter()," ")),mentionKey:m,mentionData:c}}function g(e,t,n){var o=c(e),i=o.editorState,r=o.mentionKey,s=o.mentionData;t.draft.change(i),t.mentionSuggestions.onApplyMentionToRange({mentionKey:r,mentionData:s,user:n})}Object.defineProperty(t,"__esModule",{value:!0});var p=(function(e){function t(t){var n=e.call(this,{type:"macro: @",delimiter:"@",spanProps:{className:"active-mention"}})||this;return n.mentionsOptions=t,n.onDelimiter=function(e){var t=n.options.delimiter,o=e.innerProps,i=o.text,r=o.offset,s=o.input,a=r-t.length+s.length;if(i.substring(a,r)+s===t&&(0===a||" "===i.substr(a-1,1)))return{start:a,end:r,text:i.substring(a,r)+s}},n.onMacro=function(e){var t=e.innerProps,o=t.content,i=t.entityKey,r=t.blockKey,s=t.macroEndOffset,u=t.macroStartOffset,c=n.options.type,g=n.getQuery(o);return e.triggers.suggestion.updateTotalSuggestions(0),e.triggers.suggestion.updateSelectedIndex(-1),n.mentionsOptions.onMentionsQueryUpdated(g),{blockKey:r,entityKey:i,content:o,type:c,endOffset:s,startOffset:u,chrome:a.MentionSuggestionsListComponent}},n.onAutoComplete=function(e){window.setTimeout(function(){n.completeMentionImpl(e)},0)},n.getSuggestedMentionUsers=function(e){var t=e.status.macro;if(t.active){var o=e.status.mentionSuggestions,i=t.active,r=i.content;if(i.type===n.options.type){var s=n.getQuery(r);return o.userMap[s]}}},n.getSelectedUser=function(e){var t=(e.kernel,e.status),n=t.suggestion,o=t.mentionSuggestions.users;if(n.selectedIndex!==-1&&null!==o)return o[n.selectedIndex]},n}return n.__extends(t,e),t.prototype.updateUsers=function(e){return e.kernel.compose(this.getSuggestedMentionUsers)||null},t.prototype.triggerQueryUpdateOnSuggestions=function(e){var t=e.innerProps.prevStatus.mentionSuggestions,n=t.userMap,o=t.users,i=e.status.mentionSuggestions,r=i.userMap,s=i.users;n!==r&&e.triggers.mentionSuggestions.queryUpdate(null),o!==s&&s&&e.triggers.suggestion.updateTotalSuggestions(s.length)},t.prototype.triggerQueryUpdateOnMacro=function(e){e.triggers.mentionSuggestions.queryUpdate(null)},t.prototype.completeMentionImpl=function(e){function t(e,t){return e.entityKey===t.getEntity()}var n=e.status,o=e.triggers,i=n.draft,r=n.macro,s=i.editorState.getCurrentContent();if(r.active){var a=s.getBlockForKey(r.active.blockKey),c=e.kernel.compose(this.getSelectedUser);if(c){var p=c.name.public||c.email,m=c.email,l=function(e){return!!r.active&&t(r.active,e)},d=function(e,t){return r.active&&g({editorState:i.editorState,blockKey:r.active.blockKey,identifier:m,text:p,start:e,end:t},o,c)};a.findEntityRanges(l,d)}else{var y=r.active.content.substring(this.options.delimiter.length);if(u.parseEmail(y)&&!this.mentionsOptions.disableEmailMention){var l=function(e){return!!r.active&&t(r.active,e)},d=function(e,t){return r.active&&g({editorState:i.editorState,blockKey:r.active.blockKey,identifier:y,text:y,start:e,end:t},o,c)};a.findEntityRanges(l,d)}}}},t.prototype.getQuery=function(e){var t=this.options.delimiter;return 0===e.indexOf(t)?e.substring(t.length):e},n.__decorate([o.plug(i.into.mentionSuggestions.on.queryUpdate.update.users)],t.prototype,"updateUsers",null),n.__decorate([o.plug(i.into.mentionSuggestions)],t.prototype,"triggerQueryUpdateOnSuggestions",null),n.__decorate([o.plug(i.into.macro.on.update)],t.prototype,"triggerQueryUpdateOnMacro",null),t})(s.MacroLayer);t.MentionsMacroLayer=p,t.createMentionEntity=c,t.applyMentionToRange=g});
//# sourceMappingURL=mentions_macro.min.js-vflARfNng.map